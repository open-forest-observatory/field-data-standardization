---
title: "OHDS_Trees"
author: "Victoria Mattsson"
date: "2025-04-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load Packages
```{r}

library(dplyr)
library(tidyverse)
library(readxl)

```

Load and merge datasets
```{r}

# Load Data

treesraw <- read_csv("/Users/Victoria/Documents/OFO/OHDS_StemPlots.csv") # 6206 rows
coordsraw <- read_excel("/Users/Victoria/Documents/OFO/StemCoordinates_DataOHDS.xlsx") # 13658 rows


# Reclassify plot ID's, assign unique ID

trees <- treesraw %>% mutate(
    plot_id = case_when(
      PLOT == "Bait_405" ~ "0270",
      PLOT == "Clavicle_302" ~ "0271",
      PLOT == "Fresca_202" ~ "0272",
      PLOT == "Fulton_601" ~ "0273",
      PLOT == "Rail_103" ~ "0274",
      PLOT == "Snow_805" ~ "0275",
      PLOT == "Triton_703" ~ "0276"),
    unique_id = paste(plot_id, Tree_no, Recruit, sep = "_"))

coords <- coordsraw %>% mutate(
    plot_id = case_when(
      Plot == "405" ~ "0270",
      Plot == "302" ~ "0271",
      Plot == "202" ~ "0272",
      Plot == "601" ~ "0273",
      Plot == "103" ~ "0274",
      Plot == "805" ~ "0275",
      Plot == "703" ~ "0276"),
    unique_id = paste(plot_id, Tree_no, RECRUIT, sep = "_"))


# Join datasets

trees <- left_join(trees, coords, by = "unique_id")
# note this does not retain the 7452 trees only found in coords dataset

```

Filter out logged trees?
```{r}

# Maybe: remove trees with tree_no over 9000? emily says these were logged in her olympic.rmd... not sure where this information came from though

# subset(trees, trees$Tree_no.x > 9000) # how many would be removed ? 86 trees
trees <- subset(trees, trees$Tree_no.x < 9000)

```

Standardize to OFO format
```{r}

# Reclassify column values and add columns

trees <- trees %>% mutate(
    tree_id = "",
    plot_id2 = "",
    subplot_id = "",
    height_allometric = "",
    height_above_plot_center = "",
    species = case_when(
      Species.x == "PSME" ~ "202",
      Species.x == "TSHE" ~ "263",
      Species.x == "UNCL" ~ "0", 
      Species.x == "ABAM" ~ "11",
      Species.x == "ALRU2" ~ "351",
      Species.x == "PISI" ~ "98",
      Species.x == "UNCLS" ~ "0", # unclassified softwood
      Species.x == "RHPU" ~ "RHPU", # does not have FIA or species-codes sheet code
      Species.x == "THPL" ~ "242",
      Species.x == "SASP" ~ "924",
      Species.x == "PREM" ~ "768",
      Species.x == "ACCI" ~ "ACECIR", # from species-codes sheet
      Species.x == "ACMA3" ~ "312",
      Species.x == "TABR" ~ "231"), # check! species-codes says TABR2 = 231
    growth_form = "", 
    live_dead = case_when( 
      TC == "10" ~ "L",
      TC == "11" ~ "L",
      TC == "12" ~ "L",
      TC == "13" ~ "L",
      TC == "21" ~ "D",
      TC == "22" ~ "D",
      DamA == "DI" ~ "M"),  # I think this makes sense, but not sure
    crown_position = case_when(
      CC == "7" ~ "1", 
      CC == "1" ~ "2", 
      CC == "2" ~ "3", 
      CC == "3" ~ "4", 
      CC == "4" | CC == "5" ~ "5", # labeled as overtopped if suppressed OR if understory (not sure if this should be same class)
      TRUE ~ ""), 
    ohvis = case_when(
      crown_position == 1 | crown_position == 2 | crown_position == 3 ~ "TRUE",
      crown_position == 4 | crown_position == 5 ~ "FALSE", 
      TRUE ~ ""),
    crown_ratio = "",
    crown_ratio_compacted = "",
    height_to_crown = pmin(HlcLeft, HlcRight, na.rm = TRUE), 
            # height to live crown measured for left and right side of trees -> take min
    height_to_needle = "",
    scorch_height = "",
    percent_prefire_crown_green = "",
    percent_postfire_crown_green = "",
    live_crown_class = "",
    crown_width_1 = (CWLeft + CWRight), # calculate by adding crown width left side and right side
    crown_width_2 = "",
    crown_width_allometric = "",
    decay_class = "",
    damage_1 = case_when(
      DamA == "FT" ~ "90004", # forked top 
      DamA == "BT" ~ "90001", # broken top
      DamA == "CR" | DamA == "SW" | DamA == "XL" ~ "90006", # crook or sweep... or lean?
      DamA == "DT" ~ "90002", # dead top
      DamA == "SB" ~ "9011", # open wound?
      TRUE ~ ""),
    damage_2 = "",
    damage_3 = "",
    damage_4 = "",
    damage_5 = "",
    distance_to_pith = (Dist + (0.5 * 0.01 * Post_Dbh)), # dist to face + radius of tree in meters
    notes = case_when(
      !is.na(Comments.x) & !is.na(Comments.y) ~ paste(Comments.x, Comments.y, sep = ", "),
      !is.na(Comments.x) ~ Comments.x,
      !is.na(Comments.y) ~ Comments.y), # comments exist for both datasets -> combine into one 'notes' col
    corrected_error = "") %>% 
  rename(
    plot_id = plot_id.x,
    tree_lat = Y_Lat,
    tree_lon = X_Long,
    height = Ht,
    dbh = Post_Dbh,
    distance_to_face = Dist,
    azimuth = Azimuth,
    contributor_tree_id = Tree_no.x) %>%  # note that contributor did not use unique id's
  subset(select = c(
    tree_id, plot_id, plot_id2, subplot_id, tree_lat, tree_lon, height, height_allometric,
    height_above_plot_center, dbh, species, growth_form, live_dead, crown_position, ohvis, crown_ratio,
    crown_ratio_compacted, height_to_crown, height_to_needle, scorch_height, percent_prefire_crown_green,
    percent_postfire_crown_green, live_crown_class, crown_width_1, crown_width_2, crown_width_allometric,
    decay_class, damage_1, damage_2, damage_3, damage_4, damage_5, distance_to_pith, distance_to_face, azimuth,
    contributor_tree_id, notes, corrected_error))

```


Export
```{r}

write.csv(trees, "/Users/Victoria/Documents/OFO/OHDS_trees_OFO.csv")

```

